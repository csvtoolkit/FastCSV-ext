name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write
  issues: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['8.2', '8.3', '8.4']
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: phpize
          
      - name: Build extension
        run: |
          phpize
          ./configure
          make
          
      - name: Validate extension
        run: |
          echo "=== Validating FastCSV extension ==="
          
          # Test if extension loads
          php -m | grep fastcsv || (echo "Extension not loaded!" && exit 1)
          
          # Test basic functionality
          php -r "
            if (!extension_loaded('fastcsv')) {
              echo 'Extension not loaded!' . PHP_EOL;
              exit(1);
            }
            echo 'FastCSV extension loaded successfully' . PHP_EOL;
            
            // Test if classes are available
            if (class_exists('FastCSVReader')) {
              echo 'FastCSVReader class available' . PHP_EOL;
            } else {
              echo 'FastCSVReader class not found!' . PHP_EOL;
              exit(1);
            }
            
            if (class_exists('FastCSVWriter')) {
              echo 'FastCSVWriter class available' . PHP_EOL;
            } else {
              echo 'FastCSVWriter class not found!' . PHP_EOL;
              exit(1);
            }
          "
          
          echo "=== Extension validation passed ==="
          
      - name: Create dist directory
        run: mkdir -p dist/releases/${{ github.ref_name }}/linux/php${{ matrix.php-version }}
        
      - name: Copy extension
        run: |
          cp modules/fastcsv.so "dist/releases/${{ github.ref_name }}/linux/php${{ matrix.php-version }}/fastcsv.so"
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds-php${{ matrix.php-version }}
          path: dist/releases/${{ github.ref_name }}/linux/php${{ matrix.php-version }}
          if-no-files-found: warn
          compression-level: 6
          overwrite: true
          include-hidden-files: false
          
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        php-version: ['8.2', '8.3', '8.4']
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: phpize
          
      - name: Build extension
        run: |
          phpize
          ./configure
          make
          
      - name: Validate extension
        run: |
          echo "=== Validating FastCSV extension ==="
          
          # Test if extension loads
          php -m | grep fastcsv || (echo "Extension not loaded!" && exit 1)
          
          # Test basic functionality
          php -r "
            if (!extension_loaded('fastcsv')) {
              echo 'Extension not loaded!' . PHP_EOL;
              exit(1);
            }
            echo 'FastCSV extension loaded successfully' . PHP_EOL;
            
            // Test if classes are available
            if (class_exists('FastCSVReader')) {
              echo 'FastCSVReader class available' . PHP_EOL;
            } else {
              echo 'FastCSVReader class not found!' . PHP_EOL;
              exit(1);
            }
            
            if (class_exists('FastCSVWriter')) {
              echo 'FastCSVWriter class available' . PHP_EOL;
            } else {
              echo 'FastCSVWriter class not found!' . PHP_EOL;
              exit(1);
            }
          "
          
          echo "=== Extension validation passed ==="
          
      - name: Create dist directory
        run: mkdir -p dist/releases/${{ github.ref_name }}/macos/php${{ matrix.php-version }}
        
      - name: Copy extension
        run: |
          cp modules/fastcsv.so "dist/releases/${{ github.ref_name }}/macos/php${{ matrix.php-version }}/fastcsv.so"
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds-php${{ matrix.php-version }}
          path: dist/releases/${{ github.ref_name }}/macos/php${{ matrix.php-version }}
          if-no-files-found: warn
          compression-level: 6
          overwrite: true
          include-hidden-files: false

  get-extension-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.extension-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Get the extension matrix
        id: extension-matrix
        uses: php/php-windows-builder/extension-matrix@v1

  build-windows:
    needs: get-extension-matrix
    runs-on: ${{ matrix.os }}
    strategy:
      matrix: ${{fromJson(needs.get-extension-matrix.outputs.matrix)}}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Force submodule update to latest main
        run: |
          echo "=== Current submodule status ==="
          git submodule status
          
          echo "=== Forcing submodule update to latest main ==="
          git submodule update --init --recursive --remote
          
          echo "=== Final submodule status ==="
          git submodule status
          
          echo "=== Submodule commit info ==="
          cd lib
          git log --oneline -5
          cd ..
        shell: bash
        
      - name: Debug - Check repository structure
        run: |
          echo "=== Repository structure ==="
          dir
          echo "=== Submodule status ==="
          git submodule status
          echo "=== lib directory contents ==="
          if (Test-Path "lib") { 
            dir lib 
            echo "=== lib source files ==="
            dir lib\*.c -ErrorAction SilentlyContinue
            dir lib\*.h -ErrorAction SilentlyContinue
          } else { 
            echo "lib directory not found!" 
          }
          echo "=== config files ==="
          if (Test-Path "config.m4") { echo "config.m4 exists" } else { echo "config.m4 missing!" }
          if (Test-Path "config.w32") { echo "config.w32 exists" } else { echo "config.w32 missing!" }
          echo "=== Root source files ==="
          dir *.c -ErrorAction SilentlyContinue
          dir *.h -ErrorAction SilentlyContinue
        shell: powershell
        
      - name: Copy lib files to root for Windows build
        run: |
          echo "=== Copying lib files to root directory ==="
          if (Test-Path "lib") {
            echo "lib directory found, copying files..."
            Copy-Item -Path "lib\*.c" -Destination "." -Force
            Copy-Item -Path "lib\*.h" -Destination "." -Force
            echo "Files copied. Root directory now contains:"
            dir *.c
            dir *.h
          } else {
            echo "ERROR: lib directory not found!"
            exit 1
          }
        shell: powershell
        
      - name: Build the extension
        uses: php/php-windows-builder/extension@v1
        with:
          php-version: ${{ matrix.php-version }}
          arch: ${{ matrix.arch == 'x86_64' && 'x64' || matrix.arch }}
          ts: ${{ matrix.ts }}
        
      - name: Debug - Check build output
        run: |
          echo "=== Build output directory ==="
          dir -Recurse -Filter "*.dll" -ErrorAction SilentlyContinue
          echo "=== Current directory after build ==="
          dir
          echo "=== Check if lib directory exists after build ==="
          if (Test-Path "lib") { echo "lib directory exists"; dir lib } else { echo "lib directory missing after build" }
          if (Test-Path "lib-backup") { echo "lib-backup directory exists"; dir lib-backup } else { echo "lib-backup directory missing" }
        shell: powershell
      - name: Create dist directory
        run: mkdir -p dist/releases/${{ github.ref_name }}/windows/php${{ matrix.php-version }}-${{ matrix.arch }}-${{ matrix.ts }}
        shell: bash
      - name: Copy Windows DLL
        run: |
          # Find the built DLL (the PHP Windows builder creates it with a specific naming pattern)
          if [ -f "php_fastcsv.dll" ]; then
            cp "php_fastcsv.dll" "dist/releases/${{ github.ref_name }}/windows/php${{ matrix.php-version }}-${{ matrix.arch }}-${{ matrix.ts }}/php_fastcsv.dll"
          elif [ -f "php_fastcsv-${{ matrix.php-version }}-${{ matrix.ts }}-vs16-${{ matrix.arch }}.dll" ]; then
            cp "php_fastcsv-${{ matrix.php-version }}-${{ matrix.ts }}-vs16-${{ matrix.arch }}.dll" "dist/releases/${{ github.ref_name }}/windows/php${{ matrix.php-version }}-${{ matrix.arch }}-${{ matrix.ts }}/php_fastcsv.dll"
          else
            echo "Looking for any DLL files..."
            find . -name "*.dll" -type f
            echo "ERROR: Could not find the built DLL file!"
            exit 1
          fi
        shell: bash
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds-php${{ matrix.php-version }}-${{ matrix.arch }}-${{ matrix.ts }}
          path: dist/releases/${{ github.ref_name }}/windows/php${{ matrix.php-version }}-${{ matrix.arch }}-${{ matrix.ts }}
          if-no-files-found: warn
          compression-level: 6
          overwrite: true
          include-hidden-files: false

  validate-release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
          
      - name: Setup PHP for validation
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: phpize
          
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/releases/${{ github.ref_name }}
          
      - name: Validate Linux builds
        run: |
          echo "=== Validating Linux builds ==="
          
          # Find and validate Linux .so files
          for so_file in dist/releases/${{ github.ref_name }}/linux-builds-php*/fastcsv.so; do
            if [ -f "$so_file" ]; then
              echo "Validating: $so_file"
              
              # Check file properties
              ls -la "$so_file"
              file "$so_file"
              
              # Test if it's a valid shared object
              if ! file "$so_file" | grep -q "shared object"; then
                echo "ERROR: $so_file is not a valid shared object!"
                exit 1
              fi
              
              echo "✓ $so_file is valid"
            fi
          done
          
      - name: Validate macOS builds
        run: |
          echo "=== Validating macOS builds ==="
          
          # Find and validate macOS .so files
          for so_file in dist/releases/${{ github.ref_name }}/macos-builds-php*/fastcsv.so; do
            if [ -f "$so_file" ]; then
              echo "Validating: $so_file"
              
              # Check file properties
              ls -la "$so_file"
              file "$so_file"
              
              # Test if it's a valid shared object
              if ! file "$so_file" | grep -q "shared object\|Mach-O"; then
                echo "ERROR: $so_file is not a valid shared object!"
                exit 1
              fi
              
              echo "✓ $so_file is valid"
            fi
          done
          
      - name: Validate Windows builds
        run: |
          echo "=== Validating Windows builds ==="
          
          # Find and validate Windows .dll files
          for dll_file in dist/releases/${{ github.ref_name }}/windows-builds-php*/php_fastcsv.dll; do
            if [ -f "$dll_file" ]; then
              echo "Validating: $dll_file"
              
              # Check file properties
              ls -la "$dll_file"
              file "$dll_file"
              
              # Test if it's a valid DLL
              if ! file "$dll_file" | grep -q "PE32\|executable"; then
                echo "ERROR: $dll_file is not a valid Windows DLL!"
                exit 1
              fi
              
              echo "✓ $dll_file is valid"
            fi
          done
          
      - name: Run basic tests
        run: |
          echo "=== Running basic functionality tests ==="
          
          # Create a temporary test file
          cat > test_fastcsv.php << 'EOF'
          <?php
          if (!extension_loaded('fastcsv')) {
            echo "ERROR: FastCSV extension not loaded!\n";
            exit(1);
          }
          
          echo "✓ FastCSV extension loaded\n";
          
          if (!class_exists('FastCSVReader')) {
            echo "ERROR: FastCSVReader class not found!\n";
            exit(1);
          }
          
          echo "✓ FastCSVReader class available\n";
          
          if (!class_exists('FastCSVWriter')) {
            echo "ERROR: FastCSVWriter class not found!\n";
            exit(1);
          }
          
          echo "✓ FastCSVWriter class available\n";
          
          // Test basic CSV operations
          try {
            $csv_data = "name,age,city\nJohn,25,New York\nJane,30,London";
            $temp_file = tempnam(sys_get_temp_dir(), 'test_csv');
            file_put_contents($temp_file, $csv_data);
            
            $reader = new FastCSVReader($temp_file);
            $row = $reader->read();
            
            if ($row && is_array($row) && count($row) === 3) {
              echo "✓ Basic CSV reading works\n";
            } else {
              echo "ERROR: Basic CSV reading failed!\n";
              exit(1);
            }
            
            unlink($temp_file);
            echo "✓ All basic tests passed\n";
            
          } catch (Exception $e) {
            echo "ERROR: Exception during testing: " . $e->getMessage() . "\n";
            exit(1);
          }
          EOF
          
          # Run the test with PHP 8.2
          php test_fastcsv.php

  create-release:
    needs: [validate-release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
          
      - name: Generate changelog
        id: changelog
        run: |
          echo "Generating changelog for tag ${{ github.ref_name }}"
          
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${{ github.ref_name }}^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, getting all commits"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Getting commits since $PREVIOUS_TAG"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges $PREVIOUS_TAG..${{ github.ref_name }})
          fi
          
          # Escape newlines for GitHub Actions
          CHANGELOG="${CHANGELOG//'%'/'%25'}"
          CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
          CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "Changelog generated with $(echo "$CHANGELOG" | wc -l) entries"
          
      - name: Create release directories
        run: |
          mkdir -p dist/releases/${{ github.ref_name }}/{linux,macos,windows,final}
          
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/releases/${{ github.ref_name }}
          
      - name: Debug - List all downloaded artifacts
        run: |
          echo "=== Full directory structure ==="
          find dist/releases/${{ github.ref_name }} -type f
          echo "=== End directory structure ==="
          
      - name: Prepare release files
        run: |
          echo "=== Starting file preparation ==="
          
          echo "Looking for .so files..."
          find dist/releases/${{ github.ref_name }} -name "*.so"
          
          echo "Looking for .dll files..."
          find dist/releases/${{ github.ref_name }} -name "*.dll"
          
          echo "=== Processing Linux builds ==="
          for artifact_dir in dist/releases/${{ github.ref_name }}/linux-builds-php*; do
            if [ -d "$artifact_dir" ]; then
              php_ver=$(basename "$artifact_dir" | grep -o 'php[0-9]\.[0-9]' | sed 's/php//')
              echo "Processing Linux artifact directory: $artifact_dir for PHP $php_ver"
              for file in $(find "$artifact_dir" -name "*.so"); do
                echo "Found Linux build: $file"
                cp -v "$file" "dist/releases/${{ github.ref_name }}/final/fastcsv-linux-php${php_ver}.so"
              done
            fi
          done
          
          echo "=== Processing macOS builds ==="
          for artifact_dir in dist/releases/${{ github.ref_name }}/macos-builds-php*; do
            if [ -d "$artifact_dir" ]; then
              php_ver=$(basename "$artifact_dir" | grep -o 'php[0-9]\.[0-9]' | sed 's/php//')
              echo "Processing macOS artifact directory: $artifact_dir for PHP $php_ver"
              for file in $(find "$artifact_dir" -name "*.so"); do
                echo "Found macOS build: $file"
                cp -v "$file" "dist/releases/${{ github.ref_name }}/final/fastcsv-macos-php${php_ver}.so"
              done
            fi
          done
          
          echo "=== Processing Windows builds ==="
          for artifact_dir in dist/releases/${{ github.ref_name }}/windows-builds-php*; do
            if [ -d "$artifact_dir" ]; then
              # Extract PHP version, architecture, and thread safety from directory name
              dir_name=$(basename "$artifact_dir")
              php_ver=$(echo "$dir_name" | grep -o 'php[0-9]\.[0-9]' | sed 's/php//')
              arch=$(echo "$dir_name" | grep -o 'x86_64\|x86' | head -1)
              ts=$(echo "$dir_name" | grep -o 'ts\|nts' | head -1)
              
              echo "Processing Windows artifact directory: $artifact_dir for PHP $php_ver $arch $ts"
              for file in $(find "$artifact_dir" -name "*.dll"); do
                echo "Found Windows build: $file"
                cp -v "$file" "dist/releases/${{ github.ref_name }}/final/fastcsv-windows-php${php_ver}-${arch}-${ts}.dll"
              done
            fi
          done
          
          echo "=== Files ready for release ==="
          ls -la dist/releases/${{ github.ref_name }}/final/ || echo "No files in final directory"
          
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            dist/releases/${{ github.ref_name }}/final/fastcsv-linux-php*.so
            dist/releases/${{ github.ref_name }}/final/fastcsv-macos-php*.so
            dist/releases/${{ github.ref_name }}/final/fastcsv-windows-php*.dll
          name: FastCSV ${{ github.ref_name }}
          body: |
            ## 🚀 FastCSV Extension ${{ github.ref_name }}
            
            A high-performance CSV parsing extension for PHP.
            
            ### 📦 Available Builds
            
            #### Linux:
            - PHP 8.2: `fastcsv-linux-php8.2.so`
            - PHP 8.3: `fastcsv-linux-php8.3.so`
            - PHP 8.4: `fastcsv-linux-php8.4.so`
            
            #### macOS:
            - PHP 8.2: `fastcsv-macos-php8.2.so`
            - PHP 8.3: `fastcsv-macos-php8.3.so`
            - PHP 8.4: `fastcsv-macos-php8.4.so`
            
            #### Windows:
            - PHP 8.2 x86_64 TS: `fastcsv-windows-php8.2-x86_64-ts.dll`
            - PHP 8.2 x86_64 NTS: `fastcsv-windows-php8.2-x86_64-nts.dll`
            - PHP 8.3 x86_64 TS: `fastcsv-windows-php8.3-x86_64-ts.dll`
            - PHP 8.3 x86_64 NTS: `fastcsv-windows-php8.3-x86_64-nts.dll`
            - PHP 8.4 x86_64 TS: `fastcsv-windows-php8.4-x86_64-ts.dll`
            - PHP 8.4 x86_64 NTS: `fastcsv-windows-php8.4-x86_64-nts.dll`
            
            ### 🔧 Installation
            
            #### Linux/macOS:
            1. **Download** the appropriate file for your platform and PHP version
            2. **Rename** the downloaded file to `fastcsv.so`
            3. **Copy** to your PHP extensions directory:
               ```bash
               # Find your PHP extension directory
               php -i | grep extension_dir
               
               # Copy and rename (example for Linux PHP 8.2)
               cp fastcsv-linux-php8.2.so /path/to/extension_dir/fastcsv.so
               ```
            4. **Configure** your php.ini:
               ```ini
               extension=fastcsv.so
               ```
            5. **Restart** your PHP service/server
            
            #### Windows:
            1. **Download** the appropriate DLL for your PHP version and thread safety
            2. **Rename** the downloaded file to `php_fastcsv.dll`
            3. **Copy** to your PHP extensions directory:
               ```cmd
               # Find your PHP extension directory
               php -i | findstr extension_dir
               
               # Copy and rename (example for PHP 8.2 TS)
               copy fastcsv-windows-php8.2-x86_64-ts.dll C:\path\to\ext\php_fastcsv.dll
               ```
            4. **Configure** your php.ini:
               ```ini
               extension=php_fastcsv.dll
               ```
            5. **Restart** your web server
            
            ### ✅ Verify Installation
            ```bash
            # Check if the extension is loaded
            php -m | grep fastcsv
            
            # Test basic functionality
            php -r "var_dump(extension_loaded('fastcsv'));"
            ```
            
            ### 📝 Changes in this Release
            
            ${{ steps.changelog.outputs.changelog }}
            
            ### 🐛 Issues & Support
            
            If you encounter any issues, please [open an issue](https://github.com/${{ github.repository }}/issues) on GitHub.
          draft: false
          prerelease: false
          generate_release_notes: false
          fail_on_unmatched_files: false 