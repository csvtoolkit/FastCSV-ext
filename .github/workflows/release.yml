name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['8.2', '8.3', '8.4']
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: phpize
          
      - name: Build extension
        run: |
          phpize
          ./configure
          make
          
      - name: Create dist directory
        run: mkdir -p dist/releases/${{ github.ref_name }}/linux/php${{ matrix.php-version }}
        
      - name: Copy extension
        run: |
          cp modules/fastcsv.so "dist/releases/${{ github.ref_name }}/linux/php${{ matrix.php-version }}/fastcsv.so"
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds-php${{ matrix.php-version }}
          path: dist/releases/${{ github.ref_name }}/linux/php${{ matrix.php-version }}
          if-no-files-found: warn
          compression-level: 6
          overwrite: true
          include-hidden-files: false
          
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        php-version: ['8.2', '8.3', '8.4']
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: phpize
          
      - name: Build extension
        run: |
          phpize
          ./configure
          make
          
      - name: Create dist directory
        run: mkdir -p dist/releases/${{ github.ref_name }}/macos/php${{ matrix.php-version }}
        
      - name: Copy extension
        run: |
          cp modules/fastcsv.so "dist/releases/${{ github.ref_name }}/macos/php${{ matrix.php-version }}/fastcsv.so"
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds-php${{ matrix.php-version }}
          path: dist/releases/${{ github.ref_name }}/macos/php${{ matrix.php-version }}
          if-no-files-found: warn
          compression-level: 6
          overwrite: true
          include-hidden-files: false
          
# Temporarily disabled Windows build due to environment issues
#  build-windows:
#    runs-on: windows-latest
#    strategy:
#      matrix:
#        php-version: ['8.2', '8.3', '8.4']
#        arch: ['x64', 'x86']
#    steps:
#      - uses: actions/checkout@v4
#        with:
#          submodules: true
#          
#      - name: Setup PHP
#        uses: shivammathur/setup-php@v2
#        with:
#          php-version: ${{ matrix.php-version }}
#          arch: ${{ matrix.arch }}
#          extensions: none
#          tools: phpize
#          
#      - name: Setup Visual Studio environment
#        uses: microsoft/setup-msbuild@v1.1
#        
#      - name: Add PHP tools to PATH
#        shell: pwsh
#        run: |
#          $phpDir = (Get-Command php).Path | Split-Path -Parent
#          $devDir = Join-Path $phpDir "dev"
#          echo "$devDir" | Out-File -FilePath $env:GITHUB_PATH -Append
#          echo "$phpDir" | Out-File -FilePath $env:GITHUB_PATH -Append
#          
#      - name: Build extension
#        shell: cmd
#        run: |
#          cd %GITHUB_WORKSPACE%
#          phpize
#          configure --enable-fastcsv
#          nmake
#          
#      - name: Create dist directory
#        run: mkdir -p dist/releases/${{ github.ref_name }}/windows/php${{ matrix.php-version }}-${{ matrix.arch }}
#        
#      - name: Copy extension
#        shell: pwsh
#        run: |
#          Copy-Item "Release_TS\php_fastcsv.dll" "dist/releases/${{ github.ref_name }}/windows/php${{ matrix.php-version }}-${{ matrix.arch }}/fastcsv.dll"
#          
#      - name: Upload artifact
#        uses: actions/upload-artifact@v4
#        with:
#          name: windows-builds-php${{ matrix.php-version }}-${{ matrix.arch }}
#          path: dist/releases/${{ github.ref_name }}/windows/php${{ matrix.php-version }}-${{ matrix.arch }}
#          if-no-files-found: warn
#          compression-level: 6
#          overwrite: true
#          include-hidden-files: false

  create-release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/releases/${{ github.ref_name }}
          
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/releases/${{ github.ref_name }}/**/*
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# Temporarily disabled PECL package build
#  build-pecl-package:
#    needs: create-release
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v4
#        with:
#          submodules: true
#          
#      - name: Setup PHP
#        uses: shivammathur/setup-php@v2
#        with:
#          php-version: '8.2'
#          tools: pecl
#          
#      - name: Create PECL package
#        run: |
#          pecl package package.xml
#          
#      - name: Create dist directory
#        run: mkdir -p dist/releases/${{ github.ref_name }}/pecl
#          
#      - name: Copy PECL package
#        run: |
#          cp fastcsv-*.tgz dist/releases/${{ github.ref_name }}/pecl/
#          
#      - name: Upload PECL package
#        uses: actions/upload-artifact@v4
#        with:
#          name: pecl-package-${{ github.sha }}
#          path: dist/releases/${{ github.ref_name }}/pecl
#          if-no-files-found: warn
#          compression-level: 6
#          overwrite: true
#          include-hidden-files: false
#          
#      - name: Attach PECL package to release
#        uses: softprops/action-gh-release@v1
#        with:
#          files: dist/releases/${{ github.ref_name }}/pecl/*
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 